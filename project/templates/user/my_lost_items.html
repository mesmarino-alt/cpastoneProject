<!--templates.user/my_lost_items.html-->

{% extends 'layouts/base_user_dashboard.html' %}
{% block title %}My Lost Items | Find It Fast{% endblock %}

{% block content %}
<style>
  :root {
    --page-bg: #f7f8fc;
    --card-bg: #ffffff;
    --text: #2b2d42;
    --muted: #6c757d;
    --shadow: 0 8px 24px rgba(18, 38, 63, 0.06);
  }

  body.dark-mode {
    --page-bg: #1b1b1b;
    --card-bg: #292929;
    --text: #ffffff;
    --muted: #808080;
    --shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
  }

  body {
    background-color: var(--page-bg);
    color: var(--text);
    transition: background-color 0.3s ease, color 0.3s ease;
  }

  .card {
    background-color: var(--card-bg);
    color: var(--text);
    transition: background-color 0.3s ease, color 0.3s ease;
  }

  .form-control, .form-select {
    background-color: var(--card-bg);
    color: var(--text);
    border: 1px solid #dee2e6;
    transition: background-color 0.3s ease, color 0.3s ease;
  }

  body.dark-mode .form-control,
  body.dark-mode .form-select {
    border-color: #ffa31a;
  }

  .form-control:focus, .form-select:focus {
    background-color: var(--card-bg);
    color: var(--text);
    border-color: #ffa31a;
    box-shadow: 0 0 0 0.2rem rgba(255, 163, 26, 0.25);
  }

  table {
    color: var(--text);
  }

  table thead th {
    background-color: var(--card-bg);
    color: var(--text);
    border-color: #dee2e6;
  }

  body.dark-mode table thead th {
    border-color: #404040;
  }

  table tbody td {
    border-color: #dee2e6;
  }

  body.dark-mode table tbody td {
    border-color: #404040;
  }

  .btn-outline-primary {
    border-color: #0d6efd;
    color: #0d6efd;
  }

  body.dark-mode .btn-outline-primary {
    border-color: #ffa31a;
    color: #ffa31a;
  }

  body.dark-mode .btn-outline-primary:hover {
    background-color: #ffa31a;
    color: #1b1b1b;
  }

  .btn-outline-warning {
    border-color: #ffc107;
    color: #ffc107;
  }

  body.dark-mode .btn-outline-warning {
    border-color: #ffa31a;
    color: #ffa31a;
  }

  body.dark-mode .btn-outline-warning:hover {
    background-color: #ffa31a;
    color: #1b1b1b;
  }

  .btn-outline-danger {
    border-color: #dc3545;
    color: #dc3545;
  }

  body.dark-mode .btn-outline-danger {
    border-color: #dc3545;
    color: #dc3545;
  }

  body.dark-mode .btn-outline-danger:hover {
    background-color: #dc3545;
    color: #ffffff;
  }

  .modal-content {
    background-color: var(--card-bg);
    color: var(--text);
  }

  .modal-header {
    background: linear-gradient(90deg, #c8a2c8, #8A2BE2);
    color: #ffffff;
  }

  body.dark-mode .modal-header {
    background: linear-gradient(90deg, #ffa31a, #e68a00);
    color: #1b1b1b;
  }

  body.dark-mode .modal-body {
    background-color: #292929;
  }

  body.dark-mode .modal-body.bg-white {
    background-color: #292929 !important;
  }

  body.dark-mode .modal-footer {
    background-color: #1b1b1b;
  }

  body.dark-mode .modal-footer.bg-light {
    background-color: #1b1b1b !important;
  }

  body.dark-mode .btn-close {
    background-color: #ffffff;
  }

  body.dark-mode .text-purple {
    color: #ffa31a !important;
  }

  body.dark-mode .bg-light {
    background-color: #404040 !important;
  }

  .container-section {
    background: linear-gradient(90deg, #8d8991, #d8b5d8);
    transition: background 0.3s ease;
  }

  body.dark-mode .container-section {
    background: #1b1b1b;
  }
</style>

<div class="border rounded p-4" style="background: linear-gradient(90deg, #8d8991, #d8b5d8); min-height: 600px;">
  <div class="container-fluid">
    <div class="soft-card shadow-sm rounded mb-4">

      <!-- Header -->
      <div class="card-header soft-header d-flex justify-content-between align-items-center flex-wrap">
        <h3 class="fw-bold mb-0">
          <i class="bi bi-search me-2"></i> My Lost Items
        </h3>
        <button class="btn btn-success btn-sm rounded-pill" data-bs-toggle="modal" data-bs-target="#reportLostModal" style="background-color:#8A2BE2; color:#fff;">
          <i class="bi bi-plus-lg me-1"></i> Add lost item
        </button>
      </div>
      <br>

      <!-- Filters -->
      <div class="card mb-4 rounded shadow-sm">
        <div class="card-body py-3">
          <form class="row g-2" method="get">
            <div class="col-md-4">
              <input type="text" name="q" value="{{ request.args.get('q','') }}" class="form-control" placeholder="Search item name">
            </div>
            <div class="col-md-3">
              <select name="status" class="form-select">
                <option value="">All statuses</option>
                <option value="pending" {{ 'selected' if request.args.get('status')=='pending' }}>Pending</option>
                <option value="matched" {{ 'selected' if request.args.get('status')=='matched' }}>Matched</option>
                <option value="closed" {{ 'selected' if request.args.get('status')=='closed' }}>Closed</option>
              </select>
            </div>
            <div class="col-md-3">
              <input type="date" name="from" value="{{ request.args.get('from','') }}" class="form-control">
            </div>
            <div class="col-md-2 d-grid">
              <button class="btn btn-outline-primary">Filter</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Items Table -->
      <div class="table-panel card soft-card mb-4" >
        <div class="card-header soft-header">Lost Items Overview</div>
        <div class="card-body p-0 scrollable-table">
        <table class="table align-middle mb-0 table-fixed">
          <thead>
            <tr>
              <th>ID</th><th>Name</th><th>Last Seen</th><th>Reported At</th><th>Status</th><th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for it in items %}
            <tr>
              <td>{{ it.id }}</td>
              <td>{{ it.name }}</td>
              <td>{{ it.last_seen }}</td>
              <td>{{ it.reported_at.strftime('%Y-%m-%d') if it.reported_at else '—' }}</td>
              <td>
                <span class="badge 
                  {% if it.status == 'pending' %}bg-warning text-dark
                  {% elif it.status == 'matched' %}bg-success
                  {% else %}bg-secondary{% endif %}">
                  {{ it.status|capitalize }}
                </span>
              </td>
              <td class="d-flex gap-2">
                <!-- View button -->
                <button class="btn btn-sm btn-outline-primary rounded-pill"
                        data-bs-toggle="modal"
                        data-bs-target="#viewLostItemModal"
                        data-id="{{ it.id }}">
                  <i class="bi bi-eye"></i>
                </button>

                <!-- Edit button -->
                <button class="btn btn-sm btn-outline-warning rounded-pill"
                        data-bs-toggle="modal"
                        data-bs-target="#editLostItemModal"
                        data-id="{{ it.id }}"
                        data-name="{{ it.name }}"
                        data-category="{{ it.category }}"
                        data-description="{{ it.description }}"
                        data-lastseen="{{ it.last_seen }}"
                        data-lastseenat="{{ it.last_seen_at }}"
                        data-action="{{ url_for('user.update_lost_item', item_id=it.id) }}">
                  <i class="bi bi-pencil"></i>
                </button>

                <!-- Delete button -->
                <form method="post" action="{{ url_for('user.delete_lost_item', item_id=it.id) }}" class="d-inline">
                  <button class="btn btn-sm btn-outline-danger rounded-pill"
                          onclick="return confirm('Are you sure you want to delete this item?');">
                    <i class="bi bi-trash"></i>
                  </button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      </div>
      </div>

      {% if items|length == 0 %}
      <div class="text-center text-muted py-5">
        <p class="mb-1">No lost items reported yet.</p>
      </div>
      {% endif %}

    </div>
  </div>
</div>

<!-- Report Lost Item Modal -->
<div class="modal fade" id="reportLostModal" tabindex="-1" aria-labelledby="reportLostModalLabel">
  <div class="modal-dialog">
    <form class="modal-content" method="post" action="{{ url_for('user.report_lost') }}" enctype="multipart/form-data">
      <div class="modal-header">
        <h5 class="modal-title" id="reportLostModalLabel">Report lost item</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Item name</label>
          <input type="text" name="name" class="form-control" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Category</label>
          <select name="category" class="form-select">
            <option>Accessory</option>
            <option>Bag</option>
            <option>Electronics</option>
            <option>ID/Card</option>
            <option>Others</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Last seen location</label>
          <input type="text" name="last_seen" class="form-control" placeholder="Building, room, area">
        </div>
        <div class="mb-3">
          <label class="form-label">Date/time last seen</label>
          <input type="datetime-local" name="last_seen_at" class="form-control">
        </div>
        <div class="mb-3">
          <label class="form-label">Description</label>
          <textarea name="description" class="form-control" rows="3" placeholder="Distinctive marks, colors, etc."></textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">Photo (optional)</label>
          <input type="file" name="photo" class="form-control" accept="image/*">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-success">Submit report</button>
      </div>
    </form>
  </div>
</div>

<!-- View Lost Item Modal -->
<div class="modal fade" id="viewLostItemModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" style="max-width:700px;">
    <div class="modal-content shadow-lg border-0 rounded-4">
      
      <!-- Header -->
      <div class="modal-header text-white rounded-top-4"
           style="background: linear-gradient(90deg,#c8a2c8,#8A2BE2);">
        <h5 class="modal-title fw-bold" id="viewLostItemModalLabel">
          <i class="bi bi-eye me-2"></i> View Lost Item
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      
      <!-- Body -->
      <div class="modal-body p-4 bg-white">
        <div class="row g-4 align-items-start">
          
          <!-- Left column: item details -->
          <div class="col-md-7">
            <div class="mb-3">
              <i class="bi bi-tag text-purple me-2"></i>
              <strong>Name:</strong> <span id="modalName"></span>
            </div>
            <div class="mb-3">
              <i class="bi bi-list-ul text-purple me-2"></i>
              <strong>Category:</strong> <span id="modalCategory"></span>
            </div>
            <div class="mb-3">
              <i class="bi bi-card-text text-purple me-2"></i>
              <strong>Description:</strong> <span id="modalDescription"></span>
            </div>
            <div class="mb-3">
              <i class="bi bi-geo-alt text-purple me-2"></i>
              <strong>Last Seen:</strong> <span id="modalLastSeen"></span>
            </div>
            <div class="mb-3">
              <i class="bi bi-calendar-event text-purple me-2"></i>
              <strong>Date:</strong> <span id="modalDate"></span>
            </div>
            <div class="mb-3">
              <i class="bi bi-info-circle text-purple me-2"></i>
              <strong>Status:</strong>
              <span id="modalStatus" class="badge rounded-pill px-3 py-2"></span>
            </div>
          </div>
          
          <!-- Right column: item photo -->
          <div class="col-md-5">
            <div class="bg-light rounded-4 shadow-sm p-2 d-flex align-items-center justify-content-center" style="min-height:220px;">
              <div id="modalPhotoContainer" class="w-100 text-center">
                <!-- JS will inject <img> or placeholder here -->
              </div>
            </div>
          </div>
          
        </div>
      </div>
      
      <!-- Footer -->
      <div class="modal-footer bg-light rounded-bottom-4">
        <button class="btn btn-outline-secondary rounded-pill" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-1"></i> Close
        </button>
        <button class="btn btn-purple rounded-pill"
                id="editButtonInViewModal"
                style="background-color:#8A2BE2; color:#fff;"
                data-bs-toggle="modal"
                data-bs-target="#editLostItemModal"
                data-action="">
          <i class="bi bi-pencil-square me-1"></i> Edit / Manage
        </button>
      </div>
      
    </div>
  </div>
</div>

<!-- Edit Lost Item Modal -->
<div class="modal fade" id="editLostItemModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" style="max-width:600px;">
    <div class="modal-content shadow-lg border-0 rounded-4">
      
      <!-- Header -->
      <div class="modal-header text-white rounded-top-4"
           style="background: linear-gradient(90deg,#d8b5d8,#8A2BE2);">
        <h5 class="modal-title fw-bold" id="editLostItemModalLabel">
          <i class="bi bi-pencil-square me-2"></i> Edit Lost Item
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      
      <!-- Form -->
      <form method="post" id="editLostItemForm">
        <div class="modal-body p-3 bg-white">
          <div class="mb-2">
            <label class="form-label fw-semibold">
              <i class="bi bi-tag text-purple me-2"></i> Name
            </label>
            <input type="text" name="name" id="editName" class="form-control rounded-pill" required>
          </div>
          
          <div class="mb-2">
            <label class="form-label fw-semibold">
              <i class="bi bi-list-ul text-purple me-2"></i> Category
            </label>
            <select name="category" id="editCategory" class="form-select rounded-pill">
              <option value="Accessory">Accessory</option>
              <option value="Bag">Bag</option>
              <option value="Electronics">Electronics</option>
              <option value="ID/Card">ID/Card</option>
              <option value="Others">Others</option>
            </select>
          </div>
          
          <div class="mb-2">
            <label class="form-label fw-semibold">
              <i class="bi bi-geo-alt text-purple me-2"></i> Last Seen Location
            </label>
            <input type="text" name="last_seen" id="editLastSeen" class="form-control rounded-pill">
          </div>
          
          <div class="mb-2">
            <label class="form-label fw-semibold">
              <i class="bi bi-calendar-event text-purple me-2"></i> Date/Time Last Seen
            </label>
            <input type="datetime-local" name="last_seen_at" id="editLastSeenAt" class="form-control rounded-pill">
          </div>
          
          <div class="mb-2">
            <label class="form-label fw-semibold">
              <i class="bi bi-card-text text-purple me-2"></i> Description
            </label>
            <textarea name="description" id="editDescription" class="form-control rounded-3" rows="2"></textarea>
          </div>
        </div>
        
        <!-- Footer -->
        <div class="modal-footer bg-light rounded-bottom-4">
          <button class="btn btn-outline-secondary rounded-pill" data-bs-dismiss="modal">
            <i class="bi bi-x-circle me-1"></i> Cancel
          </button>
          <button class="btn btn-purple rounded-pill" type="submit" style="background-color:#8A2BE2; color:#fff;">
            <i class="bi bi-check-circle me-1"></i> Save Changes
          </button>
        </div>
      </form>
      
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const darkMode = localStorage.getItem('darkMode') === 'true';
  if (darkMode) {
    document.body.classList.add('dark-mode');
  }

  console.log('=== my_lost_items.js loaded ===');
  
  const viewModal = document.getElementById('viewLostItemModal');
  
  if (!viewModal) {
    console.error('Modal element not found!');
    return;
  }
  
  viewModal.addEventListener('show.bs.modal', event => {
    const button = event.relatedTarget;
    const itemId = button?.getAttribute('data-id');
    
    if (!itemId) {
      console.error('No item ID found in data-id attribute');
      return;
    }
    
    const url = `/user/api/lost_items/${itemId}`;
    
    fetch(url, {
      credentials: 'include',
      method: 'GET'
    })
      .then(response => {
        if (!response.ok) {
          return response.text().then(text => {
            throw new Error(`HTTP ${response.status}: ${text}`);
          });
        }
        return response.json();
      })
      .then(data => {
        console.log('✓ Successfully received data:', data);
        
        // Populate modal fields
        const fields = {
          'modalName': data.name,
          'modalCategory': data.category,
          'modalDescription': data.description,
          'modalLastSeen': data.last_seen,
          'modalDate': data.reported_at
        };
        
        for (const [fieldId, value] of Object.entries(fields)) {
          const element = document.getElementById(fieldId);
          if (element) {
            element.textContent = value || '—';
            console.log(`Updated ${fieldId}: ${value}`);
          } else {
            console.warn(`Field #${fieldId} not found in DOM`);
          }
        }
        
        // Update status badge
        const statusEl = document.getElementById('modalStatus');
        if (statusEl) {
          const status = (data.status || '').toLowerCase();
          statusEl.textContent = status ? status.charAt(0).toUpperCase() + status.slice(1) : '—';
          statusEl.className = 'badge rounded-pill px-3 py-2 ' + (
            status === 'pending' ? 'bg-warning text-dark' :
            status === 'matched' ? 'bg-success' :
            'bg-secondary'
          );
          console.log('Updated status badge:', status);
        } else {
          console.warn('Status element #modalStatus not found');
        }
        
        // Update photo
        const photoContainer = document.getElementById('modalPhotoContainer');
        if (photoContainer) {
          if (data.photo) {
            const photoUrl = `/static/uploads/${data.photo}`;
            photoContainer.innerHTML = `<img src="${photoUrl}" class="img-fluid rounded border" alt="Item photo" onerror="console.error('Photo failed to load from: ${photoUrl}')">`;
            console.log('Photo set:', photoUrl);
          } else {
            photoContainer.innerHTML = `<div class="text-muted border rounded p-3 text-center">No photo</div>`;
            console.log('No photo available');
          }
        } else {
          console.warn('Photo container #modalPhotoContainer not found');
        }

        // Update edit button in view modal
        const editButton = document.getElementById('editButtonInViewModal');
        if (editButton) {
          editButton.setAttribute('data-name', data.name);
          editButton.setAttribute('data-category', data.category);
          editButton.setAttribute('data-lastseen', data.last_seen);
          editButton.setAttribute('data-lastseenat', data.last_seen_at);
          editButton.setAttribute('data-description', data.description);
          // FIX: match Flask route
          editButton.setAttribute('data-action', `/user/lost/${data.id}/update`);
          console.log('Updated edit button in view modal with item data');
        } else {
          console.warn('Edit button in view modal not found');
        }

      })
      .catch(error => {
        console.error('✗ Fetch failed:', error);
        const photoContainer = document.getElementById('modalPhotoContainer');
        if (photoContainer) {
          photoContainer.innerHTML = `<div class="alert alert-danger" role="alert"><strong>Error:</strong> ${error.message}</div>`;
        }
      });
  });

  // Edit modal
  const editModal = document.getElementById('editLostItemModal');
  
  if (editModal) {
    editModal.addEventListener('show.bs.modal', event => {
      const button = event.relatedTarget;
      
      const data = {
        name: button?.getAttribute('data-name'),
        category: button?.getAttribute('data-category'),
        lastSeen: button?.getAttribute('data-lastseen'),
        lastSeenAt: button?.getAttribute('data-lastseenat'),
        description: button?.getAttribute('data-description'),
        action: button?.getAttribute('data-action')
      };
      
      document.getElementById('editName').value = data.name || '';
      document.getElementById('editCategory').value = data.category || '';
      document.getElementById('editLastSeen').value = data.lastSeen || '';
      document.getElementById('editLastSeenAt').value = data.lastSeenAt || '';
      document.getElementById('editDescription').value = data.description || '';
      
      const form = document.getElementById('editLostItemForm');
      if (form) {
        form.action = data.action || '';
      }
    });
  }
});
</script>

{% endblock %}
